# TDD Implementation Plan: Google Vision API OCR Integration

Based on the **Slipstream PRD**, the Google Vision API OCR Integration is a core component (Priority: P0) of the system. Its primary role is to extract raw text from receipt images downloaded from Google Drive.

## 1. Requirements Summary

### Key Requirements:
*   **Input**: Image files (JPG, PNG) downloaded from Google Drive.
*   **Output**: Raw text data extracted from the image.
*   **Functionality**:
    *   Support for various receipt formats (vertical/horizontal).
    *   Capability to recognize English, Chinese, Japanese, and Korean text.
*   **Performance Metrics**:
    *   Accuracy: > 85% recognition rate on clear receipts.
    *   Speed: Processing time < 5 seconds per receipt.

## 2. Test Organization
*   **Unit Tests**: `tests/unit/test_ocr_engine.py` (Mocking Google Cloud Vision API).
*   **Integration Tests**: `tests/integration/test_vision_api.py` (Real API calls, optional/manual trigger).
*   **Implementation File**: `src/slipstream/integrations/ocr.py`.

## 3. Test Scenarios & Implementation Milestones

| Milestone | Scenario | Input | Expected Output |
| :--- | :--- | :--- | :--- |
| **1. Initialization** | Client setup | API Credentials | `OCREngine` instance created successfully. |
| **2. Text Extraction (Basic)** | Clear English receipt | `tests/dataset/receipt_en.png` | String containing key English text from receipt. |
| **3. Multi-language** | CJK/English receipt | `tests/dataset/receipt_zh_tw.png`, `receipt_jp.png`, `receipt_kr.png` | String containing recognized characters (ZH, JA, KO). |
| **4. Error Handling** | Invalid file path | Non-existent path | `FileNotFoundError` or custom `OCRError`. |
| **5. API Errors** | API Quota Exceeded | Valid image | Graceful handling of Google API exceptions. |
| **6. Empty Content** | Blank image | Path to `blank.jpg` | Empty string or specific "No text found" indicator. |

## 4. Edge Cases & Error Strategy
*   **Image Quality**: Low-resolution or blurry images (Test that it returns whatever it can find without crashing).
*   **Large Files**: Exceeding Google Vision size limits (Validate file size before sending).
*   **Network Issues**: Connectivity lost during request (Retry logic implementation).

## 5. TDD Checklist

- [x] **Phase 1: Setup & Unit Tests (Red)**
    - [x] Create `tests/unit/test_ocr_engine.py`.
    - [x] Write test for `OCREngine` initialization (Mock `vision.ImageAnnotatorClient`).
    - [x] Write test for `extract_text` with mock response.
- [x] **Phase 2: Minimal Implementation (Green)**
    - [x] Create `src/slipstream/integrations/ocr.py`.
    - [x] Implement `OCREngine` class.
    - [x] Implement `extract_text` method using `google-cloud-vision` library.
    - [x] Run tests to ensure they pass with mocks.
- [x] **Phase 3: Refactoring**
    - [x] Clean up redundant code in `ocr.py`.
    - [x] Ensure consistent error logging and exception types.
- [x] **Phase 4: Advanced Scenarios**
    - [x] Add tests for image pre-validation (file type, size).
    - [x] Update implementation to handle these cases.
- [x] **Phase 5: Integration Check**
    - [x] Create a small script/test to run against a real sample image (using local credentials).
    - [x] Verify that the output meets the >85% accuracy requirement qualitatively.

## 6. Suggested Implementation Snippet (Post-Test)

```python
from google.cloud import vision

class OCREngine:
    def __init__(self, client=None):
        self.client = client or vision.ImageAnnotatorClient()

    def extract_text(self, image_path: str) -> str:
        # 1. Load image
        # 2. Call Google Vision text_detection
        # 3. Handle errors
        # 4. Return description of first annotation
        pass
```
