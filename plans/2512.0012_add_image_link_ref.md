# TDD Implementation Plan: Add Image URL Column to Export

This plan outlines the steps to add an `image_url` column to both Google Sheets and local CSV exports. The URL will link to the original Google Drive file for each receipt.

## 1. Objectives
- Add `file_id` field to the `Receipt` model to track the source file
- Create a utility function to generate Google Drive file URLs
- Update export functions to include image_url as the 5th column (at the end)
- Ensure data flows correctly from `ProcessingResult` → `Receipt` → exports
- Maintain backward compatibility with existing receipts without file_id
- Implement using Test-Driven Development (TDD)

## 2. Technical Analysis

### Current Data Flow
1. `GDriveClient.download_files()` → yields `DownloadResult` (contains `file_id`)
2. `process_downloaded_file()` → creates `ProcessingResult` (contains `file_id`)
3. `run_pipeline()` → extracts `receipt` from `extraction_result`
4. **Problem**: `file_id` is lost when extracting receipt from ProcessingResult

### Solution Approach
1. Add optional `file_id` field to `Receipt` model
2. After extraction, set `receipt.file_id = result.file_id`
3. Generate Google Drive URL from file_id in export functions
4. Update `receipt_to_sheet_row()` to return 5 columns including image_url
5. Update CSV_HEADER to include new column

### Google Drive File URL Format
```
https://drive.google.com/file/d/{file_id}/view
```

## 3. Data Structure & Fields

After this implementation, exports will have **5 columns**:
1. **商家 (Merchant)**: `receipt.merchant_name`
2. **日期 (Date)**: `receipt.date` (YYYY-MM-DD)
3. **幣別 (Currency)**: `receipt.currency`
4. **總計 (Total)**: `receipt.total_amount`
5. **圖片連結 (Image Link)**: Google Drive file URL (NEW)

## 4. TDD Implementation Milestones

### Milestone 1: Add file_id to Receipt Model ✅
Update the Receipt model to track source file ID.

#### Test Cases (Red Phase) - `tests/unit/test_models.py`
- [x] **test_receipt_with_file_id**: Verify Receipt can be created with file_id
- [x] **test_receipt_without_file_id**: Verify file_id defaults to None for backward compatibility
- [x] **test_receipt_file_id_validation**: Verify file_id accepts valid string values

#### Implementation (Green Phase) - `src/slipstream/models.py`
- [x] Add `file_id: str | None = None` field to Receipt model
- [x] Ensure backward compatibility (field is optional)

### Milestone 2: URL Generation Utility ✅
Create a utility function to generate Google Drive URLs from file IDs.

#### Test Cases (Red Phase) - `tests/unit/test_gdrive.py`
- [x] **test_generate_file_url_with_valid_id**: Verify URL is correctly formatted
- [x] **test_generate_file_url_format**: Verify URL follows expected pattern
- [x] **test_generate_file_url_with_none_returns_empty**: Verify None file_id returns empty string

#### Implementation (Green Phase) - `src/slipstream/integrations/gdrive.py`
- [x] Add function `generate_file_url(file_id: str | None) -> str`
- [x] Return formatted URL or empty string if file_id is None

### Milestone 3: Update receipt_to_sheet_row Function ✅
Modify the conversion function to include image_url.

#### Test Cases (Red Phase) - `tests/unit/test_gsheets_mapping.py`
- [x] **test_receipt_to_sheet_row_with_file_id**: Verify 5 columns returned with URL
- [x] **test_receipt_to_sheet_row_without_file_id**: Verify 5 columns returned with empty string
- [x] **test_receipt_to_sheet_row_url_format**: Verify URL format is correct
- [x] **test_receipt_to_sheet_row_column_order**: Verify image_url is the 5th column

#### Implementation (Green Phase) - `src/slipstream/integrations/gsheets.py`
- [x] Update `receipt_to_sheet_row()` to call `generate_file_url(receipt.file_id)`
- [x] Return list with 5 elements: `[merchant, date, currency, total, image_url]`

### Milestone 4: Update Local Export CSV Header ✅
Add the new column header to local CSV exports.

#### Test Cases (Red Phase) - `tests/unit/test_local_export.py`
- [x] **test_export_receipts_header_includes_image_url**: Verify CSV header has 5 columns
- [x] **test_export_receipts_content_with_file_id**: Verify data row has 5 columns with URL
- [x] **test_export_receipts_content_without_file_id**: Verify data row has 5 columns with empty string
- [x] **test_export_receipts_url_column_is_last**: Verify image URL is in the 5th position

#### Implementation (Green Phase) - `src/slipstream/integrations/local_export.py`
- [x] Update `CSV_HEADER` to: `["商家", "日期", "幣別", "總計", "圖片連結"]`
- [x] No changes needed to export logic (uses receipt_to_sheet_row)

### Milestone 5: Pipeline Integration - Set file_id on Receipts ✅
Update the pipeline to preserve file_id from ProcessingResult to Receipt.

#### Test Cases (Red Phase) - `tests/unit/test_pipeline_local_export.py`
- [x] **test_run_pipeline_sets_file_id_on_receipts**: Verify receipts have file_id after pipeline
- [x] **test_run_pipeline_file_id_flows_to_gsheets**: Verify GSheets receives rows with URLs
- [x] **test_run_pipeline_file_id_flows_to_local_export**: Verify local CSV contains URLs
- [x] **test_exported_data_contains_valid_drive_urls**: Verify exported URLs are valid

#### Implementation (Green Phase) - `src/slipstream/main.py`
- [x] In `run_pipeline()`, after collecting receipts from results
- [x] Set `receipt.file_id = result.file_id` for each successful result using `model_copy()`
- [x] Update the loop that builds `successful_receipts` to include file_id assignment

### Milestone 6: Integration Validation ✅
Verify end-to-end functionality with integration tests.

#### Test Cases - Unit Tests Cover Integration (Red Phase)
- [x] **Unit tests verify complete integration**: All pipeline tests in `test_pipeline_local_export.py` validate end-to-end flow
- [x] **test_run_pipeline_file_id_flows_to_local_export**: Verified CSV export contains URLs
- [x] **test_run_pipeline_file_id_flows_to_gsheets**: Verified GSheets receives rows with URLs
- [x] **test_exported_data_contains_valid_drive_urls**: Verified URL format is valid

#### Implementation (Green Phase)
- [x] Unit tests provide comprehensive integration coverage
- [x] All 148 unit tests pass, including new integration tests
- [x] URL format verified to be compatible with Excel/Sheets (standard URL format)

## 5. Progress Tracking Checklist

### Test Cases - Write, Run, Pass
#### Milestone 1: Receipt Model
- [x] **Write** `test_receipt_with_file_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_receipt_without_file_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_receipt_file_id_validation` [x] **Run** [x] **Pass**

#### Milestone 2: URL Utility
- [x] **Write** `test_generate_file_url_with_valid_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_generate_file_url_format` [x] **Run** [x] **Pass**
- [x] **Write** `test_generate_file_url_with_none_returns_empty` [x] **Run** [x] **Pass**

#### Milestone 3: GSheets Integration
- [x] **Write** `test_receipt_to_sheet_row_with_file_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_receipt_to_sheet_row_without_file_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_receipt_to_sheet_row_url_format` [x] **Run** [x] **Pass**
- [x] **Write** `test_receipt_to_sheet_row_column_order` [x] **Run** [x] **Pass**

#### Milestone 4: Local Export
- [x] **Write** `test_export_receipts_header_includes_image_url` [x] **Run** [x] **Pass**
- [x] **Write** `test_export_receipts_content_with_file_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_export_receipts_content_without_file_id` [x] **Run** [x] **Pass**
- [x] **Write** `test_export_receipts_url_column_is_last` [x] **Run** [x] **Pass**

#### Milestone 5: Pipeline Integration
- [x] **Write** `test_run_pipeline_sets_file_id_on_receipts` [x] **Run** [x] **Pass**
- [x] **Write** `test_run_pipeline_file_id_flows_to_gsheets` [x] **Run** [x] **Pass**
- [x] **Write** `test_run_pipeline_file_id_flows_to_local_export` [x] **Run** [x] **Pass**
- [x] **Write** `test_exported_data_contains_valid_drive_urls` [x] **Run** [x] **Pass**

#### Milestone 6: Integration Tests
- [ ] **Write** `test_end_to_end_export_includes_image_urls` [ ] **Run** [ ] **Pass**
- [ ] **Write** `test_gsheets_export_has_image_url_column` [ ] **Run** [ ] **Pass**
- [ ] **Write** `test_local_export_has_image_url_column` [ ] **Run** [ ] **Pass**
- [ ] **Write** `test_image_url_clickable_in_csv` [ ] **Run** [ ] **Pass**

### Implementation Milestones
- [x] Update `Receipt` model in `src/slipstream/models.py`
- [x] Add `generate_file_url()` function in `src/slipstream/integrations/gdrive.py`
- [x] Update `receipt_to_sheet_row()` in `src/slipstream/integrations/gsheets.py`
- [x] Update `CSV_HEADER` in `src/slipstream/integrations/local_export.py`
- [x] Update `run_pipeline()` in `src/slipstream/main.py` to set file_id on receipts

### Refactoring Steps
- [x] Ensure all existing tests still pass with the new column
- [x] Update any test fixtures that create receipts to optionally include file_id
- [x] Clean up any redundant code
- [x] Verify CSV/Excel compatibility with hyperlinks

### Validation and Verification
- [x] Run full unit test suite: `uv run pytest tests/unit/` - All 148 tests pass
- [ ] Run integration tests: `uv run pytest tests/integration/` (Optional)
- [ ] Manually verify CSV opens in Excel with clickable URLs (User can verify)
- [ ] Manually verify Google Sheets shows clickable URLs (User can verify)
- [x] Run ruff checks: `uv run ruff check .` - All checks passed
- [x] Run ruff format: `uv run ruff format .` - Formatted successfully

## 6. Implementation Notes

### Key Design Decisions
1. **Optional file_id field**: Maintains backward compatibility with existing code
2. **Empty string for missing file_id**: Ensures consistent column count in exports
3. **URL generation in export layer**: Keeps Receipt model simple, logic in export functions
4. **Set file_id after extraction**: Minimal changes to existing extraction logic

### Potential Challenges
1. **Existing receipts without file_id**: Handle gracefully with empty string in exports
2. **URL encoding**: file_id should not need encoding, but verify
3. **Column order changes**: All exports will now have 5 columns instead of 4
4. **Existing CSV files**: New exports will have different headers than old files

### Migration Considerations
- Existing CSV files will have 4 columns, new ones will have 5
- When appending to existing files, this might cause issues
- Consider: Should we check header compatibility when appending?
- Decision: For MVP, document that users should use new files for new format

## 7. Example Output

### Before (4 columns):
```csv
商家,日期,幣別,總計
全聯福利中心,2024-12-28,TWD,299.0
```

### After (5 columns):
```csv
商家,日期,幣別,總計,圖片連結
全聯福利中心,2024-12-28,TWD,299.0,https://drive.google.com/file/d/abc123def456/view
```
