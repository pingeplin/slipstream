### URL Parser Requirements Summary

Based on the PRD (`docs/slipstream-prd.md`), the URL parser must handle various Google Drive and Google Sheets URL formats to extract their unique identifiers (IDs).

#### Target URL Formats and Extraction Goals:
| Type | URL Format | Extraction Result |
| :--- | :--- | :--- |
| **Drive Folder** | `https://drive.google.com/drive/folders/{ID}` | Folder ID |
| **Drive Folder (u/)** | `https://drive.google.com/drive/u/0/folders/{ID}` | Folder ID |
| **Drive File** | `https://drive.google.com/file/d/{ID}/view` | File ID |
| **Google Sheets** | `https://docs.google.com/spreadsheets/d/{ID}/edit` | Sheet ID |

#### Functional Requirements:
- **Auto-identification**: The tool must distinguish between a raw ID and a full URL.
- **Robustness**: Support variations in URLs (e.g., query parameters, different suffixes like `/view` or `/edit`).
- **Error Handling**: Provide clear, user-friendly error messages when a URL is malformed or unsupported.
- **CLI Integration**: Used by `--folder`, `--sheet`, and `--file` arguments in the `slipstream` command.

---

### TDD Implementation Plan for URL Parser

This plan follows the Red-Green-Refactor cycle, moving from basic ID validation to complex URL parsing and error handling.

#### 1. Test Organization
- **Test File**: `tests/test_url_parser.py`
- **Module to Implement**: `src/slipstream/utils/url_parser.py`
- **Framework**: `pytest`

#### 2. Implementation Milestones

| Milestone | Focus | TDD Goal |
| :--- | :--- | :--- |
| **M1: Pass-through IDs** | Handle raw IDs | Ensure input that is already an ID is returned as-is. |
| **M2: Drive Folder URLs** | Extract Folder IDs | Support standard and `/u/n/` variants. |
| **M3: Drive File URLs** | Extract File IDs | Support `/file/d/{ID}/view` format. |
| **M4: Google Sheets URLs**| Extract Sheet IDs | Support `/spreadsheets/d/{ID}/edit` format. |
| **M5: Error Handling** | Validation | Raise descriptive exceptions for invalid inputs. |

#### 3. Test Scenarios and Cases

##### Milestone 1: Raw ID Support (The "Simple" Case)
- **Scenario**: Input is already a valid ID (not a URL).
- **Test Case 1**:
  - **Input**: `1AbCdEfGhIjKlMnOpQrStUvWxYz`
  - **Expected Output**: `1AbCdEfGhIjKlMnOpQrStUvWxYz` (Identity)

##### Milestone 2: Google Drive Folders
- **Scenario**: Extract ID from various folder URL formats.
- **Test Case 2 (Standard)**:
  - **Input**: `https://drive.google.com/drive/folders/1AbCdEfGhIjKlMnOpQrStUvWxYz`
  - **Expected Output**: `1AbCdEfGhIjKlMnOpQrStUvWxYz`
- **Test Case 3 (With User Index)**:
  - **Input**: `https://drive.google.com/drive/u/0/folders/1AbCdEfGhIjKlMnOpQrStUvWxYz`
  - **Expected Output**: `1AbCdEfGhIjKlMnOpQrStUvWxYz`
- **Test Case 4 (With Query Params)**:
  - **Input**: `https://drive.google.com/drive/folders/1AbCd?usp=sharing`
  - **Expected Output**: `1AbCd`

##### Milestone 3: Google Drive Files
- **Scenario**: Extract ID from file view URLs.
- **Test Case 5**:
  - **Input**: `https://drive.google.com/file/d/1XyZwVuTsRqPoNmLkJiHgFeDcBa/view?usp=drivesdk`
  - **Expected Output**: `1XyZwVuTsRqPoNmLkJiHgFeDcBa`

##### Milestone 4: Google Sheets
- **Scenario**: Extract ID from spreadsheet edit URLs.
- **Test Case 6**:
  - **Input**: `https://docs.google.com/spreadsheets/d/1XyZwVuTsRqPoNmLkJiHgFeDcBa/edit#gid=0`
  - **Expected Output**: `1XyZwVuTsRqPoNmLkJiHgFeDcBa`

##### Milestone 5: Edge Cases and Errors
- **Scenario**: Handle malformed or non-Google URLs.
- **Test Case 7 (Invalid Domain)**:
  - **Input**: `https://dropbox.com/s/12345`
  - **Expected Output**: Raise `ValueError` with message "Unsupported URL domain"
- **Test Case 8 (Missing ID in Path)**:
  - **Input**: `https://drive.google.com/drive/folders/`
  - **Expected Output**: Raise `ValueError` with message "Could not find ID in URL"
- **Test Case 9 (Empty/Whitespace)**:
  - **Input**: `"   "`
  - **Expected Output**: Raise `ValueError`

#### 4. Python-Specific Implementation Strategy
- Use `urllib.parse` for reliable URL component extraction rather than raw regex where possible.
- Use a central function `parse_google_id(input_str: str) -> str`.
- Use `pytest.mark.parametrize` to keep the test suite concise and readable.
- Define a custom exception `URLParserError` for specific failure modes.

#### 5. TDD Workflow Steps
1. **Red**: Create `tests/test_url_parser.py` with the first test case (Raw ID). Run `pytest` and see it fail (ModuleNotFound).
2. **Green**: Create `src/slipstream/utils/url_parser.py` and implement the minimal logic to return the input string.
3. **Refactor**: Check naming and structure.
4. **Repeat**: Add the next test case (Folder URL), run `pytest` (fail), update implementation (pass), and refactor.

---

### Implementation Checklist

- [ ] **M1: Pass-through IDs**
    - [ ] Create `tests/test_url_parser.py` with Test Case 1
    - [ ] Implement `parse_google_id` in `src/slipstream/utils/url_parser.py` (Identity function)
    - [ ] Verify Test Case 1 passes
- [ ] **M2: Drive Folder URLs**
    - [ ] Add Test Case 2 (Standard Folder URL)
    - [ ] Update `parse_google_id` to handle `/drive/folders/`
    - [ ] Add Test Case 3 (User Index URL)
    - [ ] Add Test Case 4 (Query Params)
    - [ ] Verify all M2 tests pass
- [ ] **M3: Drive File URLs**
    - [ ] Add Test Case 5 (File View URL)
    - [ ] Update `parse_google_id` to handle `/file/d/`
    - [ ] Verify all M3 tests pass
- [ ] **M4: Google Sheets URLs**
    - [ ] Add Test Case 6 (Spreadsheet Edit URL)
    - [ ] Update `parse_google_id` to handle `/spreadsheets/d/`
    - [ ] Verify all M4 tests pass
- [ ] **M5: Error Handling**
    - [ ] Define `URLParserError`
    - [ ] Add Test Case 7 (Invalid Domain)
    - [ ] Add Test Case 8 (Missing ID)
    - [ ] Add Test Case 9 (Empty/Whitespace)
    - [ ] Update implementation to raise appropriate exceptions
    - [ ] Verify all tests (M1-M5) pass
- [ ] **Final Refactoring**
    - [ ] Ensure consistent use of `urllib.parse`
    - [ ] Final code style check
