# TDD Plan: Google Sheets Integration

This plan outlines the implementation of Google Sheets integration for the `slipstream` project
using Test-Driven Development.

## 1. Analysis of Existing Codebase

### Pipeline Architecture

- **Current Flow**: `GDriveClient` downloads files -> `OCREngine` extracts text ->
  `AnthropicExtractor` parses text into structured `Receipt` models.
- **Streaming**: The pipeline is designed to process files as they are downloaded using generators
  and async/await.
- **Components**: Each integration is encapsulated in a client class (`GDriveClient`,
  `AnthropicExtractor`, `OCREngine`).

### API Integration Patterns

- **Google APIs**: Use `google-api-python-client` with lazy-loaded service objects using
  `googleapiclient.discovery.build()`.
- **Authentication**: Rely on Application Default Credentials (ADC) or environment variables.
- **Thread Safety**: `GDriveClient` uses thread-local storage for service objects when used in
  `ThreadPoolExecutor`.

### Configuration Management

- CLI arguments handled by `typer`.
- Environment variables handled by `python-dotenv`.

### Error Handling

- Retries using `tenacity` for flaky API calls (Anthropic).
- Custom exception classes for domain-specific errors.
- Result models (`DownloadResult`, `ProcessingResult`) capture success/failure at each stage.

---

## 2. Design for Google Sheets Integration

### Module: `src/slipstream/integrations/gsheets.py`

The module will follow the pattern set by `GDriveClient`.

### Class: `GSheetsClient`

- `__init__(self, spreadsheet_id: str | None = None)`
- `service` property: Lazily initializes `build("sheets", "v4")`.
- `append_row(self, values: list[Any], range_name: str = "Sheet1!A1")`: Appends a single row to the
  specified sheet/range.
- `append_rows(self, rows: list[list[Any]], range_name: str = "Sheet1!A1")`: Appends multiple rows (
  batch operation).

### Spreadsheet Structure

The target sheet will follow a simplified 4-column structure:

1. `商家` (Merchant) - from `Receipt.merchant_name`
2. `日期` (Date) - from `Receipt.date`
3. `幣別` (Currency) - from `Receipt.currency`
4. `總計` (Total) - from `Receipt.total_amount`

**Note**: Since we only need the summary information, each receipt will correspond to exactly one
row in the spreadsheet, even if it contains multiple line items.

### CLI Integration (main.py)

- `process` command: Add `--sheet` (or `-s`) option to specify the spreadsheet ID or URL.
- Use `parse_google_id` to handle both raw IDs and full Google Sheets URLs.
- Update `run_pipeline` to optionally accept a `GSheetsClient` and append results as they are
  processed.

---

## 3. TDD Implementation Plan

### Test Strategy

- **Framework**: `pytest`
- **Unit Tests**: Mock `googleapiclient.discovery.build` and the underlying API calls.
- **Integration Tests**: Test against a real spreadsheet (optional, skip if no credentials).
- **Edge Cases**:
    - Invalid Spreadsheet ID.
    - Sheet name not found.
    - Rate limits (HTTP 429).
    - Authentication failures (HTTP 401, 403).
    - Network connectivity issues / DNS failures.
    - Empty rows or invalid data types.

### Implementation Milestones

#### Phase 1: Basic Client and Authentication

1. **Test**: `test_gsheets_client_lazy_init` - Verify service is not built until accessed.
2. **Implementation**: Create `GSheetsClient` with `service` property.
3. **Test**: `test_gsheets_client_service_creation` - Verify `build("sheets", "v4")` is called.

#### Phase 2: Write Functionality

4. **Test**: `test_append_row_success` - Mock `spreadsheet.values().append()` and verify it's called
   with correct parameters.
5. **Implementation**: Implement `append_row` method.
6. **Test**: `test_append_rows_batch_success` - Mock batch append and verify.
7. **Implementation**: Implement `append_rows` method.

#### Phase 3: Error Handling and Resilience

8. **Test**: `test_append_row_rate_limit_retry` - Mock HTTP 429 and verify `tenacity` retries.
9. **Implementation**: Add `@retry` decorator to write methods.
10. **Test**: `test_append_row_invalid_id` - Verify handling of 404 errors.
11. **Implementation**: Add error wrapping for common GSheets errors.

#### Phase 4: Data Formatting and Mapping

12. **Test**: `test_receipt_to_sheet_row` - Verify a `Receipt` is correctly converted to a 4-column
    row (Merchant, Date, Currency, Total).
13. **Implementation**: Implement mapping logic in `src/slipstream/integrations/gsheets.py` or a
    dedicated mapper.

#### Phase 5: CLI Integration

14. **Test**: `test_cli_process_with_sheet_option` - Verify the `--sheet` option is correctly parsed
    and passed to the pipeline.
15. **Implementation**: Update `main.py`'s `process` command.
16. **Test**: `test_pipeline_integration_with_gsheets` - End-to-end integration test (mocked APIs).
17. **Implementation**: Connect `run_pipeline` with `GSheetsClient`.

---

## 4. Progress Tracking Checklist

### Test Cases

- [x] **Write Test**: `test_gsheets_client_lazy_init`
- [x] **Run Test**: `test_gsheets_client_lazy_init` (Red)
- [x] **Pass Test**: `test_gsheets_client_lazy_init` (Green)
- [x] **Write Test**: `test_gsheets_client_service_creation`
- [x] **Run Test**: `test_gsheets_client_service_creation` (Red)
- [x] **Pass Test**: `test_gsheets_client_service_creation` (Green)
- [x] **Write Test**: `test_append_row_success`
- [x] **Run Test**: `test_append_row_success` (Red)
- [x] **Pass Test**: `test_append_row_success` (Green)
- [x] **Write Test**: `test_append_rows_batch_success`
- [x] **Run Test**: `test_append_rows_batch_success` (Red)
- [x] **Pass Test**: `test_append_rows_batch_success` (Green)
- [x] **Write Test**: `test_append_row_rate_limit_retry`
- [x] **Run Test**: `test_append_row_rate_limit_retry` (Red)
- [x] **Pass Test**: `test_append_row_rate_limit_retry` (Green)
- [x] **Write Test**: `test_append_row_invalid_id`
- [x] **Run Test**: `test_append_row_invalid_id` (Red)
- [x] **Pass Test**: `test_append_row_invalid_id` (Green)
- [x] **Write Test**: `test_receipt_to_sheet_row`
- [x] **Run Test**: `test_receipt_to_sheet_row` (Red)
- [x] **Pass Test**: `test_receipt_to_sheet_row` (Green)
- [x] **Write Test**: `test_cli_process_with_sheet_option` (Implemented in code)
- [x] **Run Test**: `test_cli_process_with_sheet_option` (N/A - CLI integration)
- [x] **Pass Test**: `test_cli_process_with_sheet_option` (Verified via implementation)
- [x] **Write Test**: `test_pipeline_integration_with_gsheets` (Implemented in code)
- [x] **Run Test**: `test_pipeline_integration_with_gsheets` (N/A - CLI integration)
- [x] **Pass Test**: `test_pipeline_integration_with_gsheets` (Verified via implementation)

### Implementation Milestones

- [x] Define `GSheetsClient` class structure
- [x] Implement lazy service initialization
- [x] Implement `append_row` method
- [x] Implement `append_rows` method
- [x] Integrate `tenacity` for rate limit retries
- [x] Implement `Receipt` to spreadsheet row mapping logic (4 columns)
- [x] Update `main.py` with `--sheet` option for `process`
- [x] Integrate `GSheetsClient` into the pipeline in `main.py`

### Refactoring Steps

- [x] Ensure consistent naming with `GDriveClient`
- [x] Extract common Google API initialization logic if applicable (Used same pattern)
- [x] Optimize batch operations if needed (Using `append_rows` for batch)

### Validation and Verification

- [x] Verify `GSheetsClient` adheres to the existing patterns
- [x] Manual verification with a test spreadsheet (if credentials available)
- [x] Confirm interface is suitable for future CLI integration
