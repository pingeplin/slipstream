### TDD Plan: Integrate Anthropic Extractor into Workflow

This plan outlines the steps to integrate the `AnthropicExtractor` into the main CLI workflow and
extend the integration tests to cover this new component.

#### 1. Analysis of Existing Integration Tests

**Current Structure and Patterns:**

- **Location:** `tests/integration/test_cli_workflow.py`
- **Pattern:** CLI input (`runner.invoke`) → component processing (URL Parser, GDrive, OCR) → Output
  validation (`verify_cli_success`, regex matching on `stdout`).
- **CLI Simulation:** Uses `typer.testing.CliRunner`.
- **API Handling:** Currently uses real Google APIs (GDrive, Vision), skipping tests if
  credentials/environment variables are missing.
- **Validation:** Checks `exit_code`, counts occurrences of specific strings in `stdout` (e.g., "
  Extracted text from"), and validates data patterns (e.g., character counts).

#### 2. Integration Goal

Extend `slipstream process` to include the LLM structure extraction step:
`CLI -> URL Parser -> GDrive -> Download -> OCR -> Anthropic LLM -> (Future: Google Sheets)`

#### 3. TDD Plan

##### Phase 1: Integration Test Preparation (Red)

1. **Test Case: `test_cli_workflow_complete_pipeline_with_llm`**
    - **Goal:** Verify the full pipeline including Anthropic extraction.
    - **Input:** Valid Google Drive folder URL/ID.
    - **Mocking:** Since real Anthropic API calls are costly and slow, we will mock
      `AnthropicExtractor.extract_receipt_data` in these integration tests.
    - **Expected Output:**
        - Exit code 0.
        - "Extracted text from..." (OCR step).
        - "Structured data extracted for..." (New LLM step).
        - Validated merchant name, date, or total amount in output (if `--verbose` or similar is
          used).

2. **Test Case: `test_cli_workflow_llm_failure_handling`**
    - **Goal:** Verify CLI handles LLM errors gracefully (continue-on-error).
    - **Simulation:** Mock LLM to raise `ExtractionIncompleteError` or `ExtractionRefusedError`.
    - **Expected Output:** Error message in stderr/stdout, but continues to next file.

##### Phase 2: Implementation (Green)

1. **Update `slipstream/main.py`:**
    - Initialize `AnthropicExtractor`.
    - After OCR extraction, call `extractor.extract_receipt_data`.
    - Print summary of extracted data.
    - Implement error handling for the extraction step.

##### Phase 3: Refinement (Refactor)

1. **Improve CLI Output:**
    - Use `rich` for better formatting of the extracted structured data.
    - Ensure clear logging of successes and failures.

#### 4. Specific Test Scenarios

| Scenario             | Description             | CLI Command             | Mock/Setup                       | Expected Result                              |
|:---------------------|:------------------------|:------------------------|:---------------------------------|:---------------------------------------------|
| **Complete Success** | Full flow including LLM | `process --folder <ID>` | Mock LLM success                 | "Structured data extracted" for each file    |
| **LLM Refusal**      | Model refuses one file  | `process --folder <ID>` | Mock 1 refusal, 1 success        | Error message for file 1, success for file 2 |
| **LLM Truncation**   | Response truncated      | `process --folder <ID>` | Mock `ExtractionIncompleteError` | Warning message, continues                   |
| **Missing API Key**  | No ANTHROPIC_API_KEY    | `process --folder <ID>` | Unset env var                    | Error message: "Anthropic API key not found" |

#### 5. Mocking Strategy for Integration Tests

In `tests/integration/conftest.py` or within the test file:

```python
@pytest.fixture
def mock_anthropic_extractor(mocker):
    mock = mocker.patch("slipstream.main.AnthropicExtractor", autospec=True)
    # Configure default behavior for instances
    return mock
```

#### 6. Task List

- [ ] Create `tests/integration/test_anthropic_integration.py` (or extend `test_cli_workflow.py`).
- [ ] Implement the Red tests (expecting failure since `main.py` isn't updated).
- [ ] Update `main.py` to include `AnthropicExtractor` logic.
- [ ] Verify tests pass (Green).
- [ ] Refactor CLI output and error handling.
- [ ] Final verification with all integration tests.
