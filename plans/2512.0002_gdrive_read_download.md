### Google Drive Read and Download - TDD Implementation Plan

#### 1. Requirements Summary (from PRD)

Based on the `slipstream-prd.md`, the Google Drive integration module (P0) has the following
requirements:

- **Connect to Google Drive API**: Successfully authenticate and establish a connection.
- **Read from Folder**: List all files within a specified Google Drive folder ID.
- **Filter File Types**: Support common image formats (JPG, PNG) and PDF.
- **Download Files**: Download the files from Google Drive to a local temporary location for
  processing.
- **Track Processed Files**: Provide a mechanism to identify which files have already been
  processed (to avoid duplication).
- **Explicit Configuration**: Folder IDs, destination paths, and other operational parameters must be passed explicitly. Authentication is handled via Google Cloud Application Default Credentials (ADC).

#### 2. Test Strategy

We will use `pytest` for testing. The strategy involves:

- **Unit Tests**: Mocking the Google Drive API client using `unittest.mock` to test logic without
  making actual network calls.
- **Integration Tests**: (Optional/Simulated) Using a mock service or strictly controlled
  environment to verify the interaction between components.
- **Organization**: Tests will be located in `tests/test_gdrive.py`.

#### 3. TDD Implementation Plan

##### Phase 1: Authentication and Client Initialization

- **Scenario 1.1**: Initialize the Google Drive service using Google Cloud Application Default Credentials (ADC).
    - **Input**: None (implicitly uses environment/gcloud auth).
    - **Output**: An initialized Google Drive service object.
- **Scenario 1.2**: Handle authentication failures gracefully.

##### Phase 2: Listing Files

- **Scenario 2.1**: List files in a valid folder ID.
    - **Input**: `folder_id` (string).
    - **Output**: List of file objects (name, id, mimeType).
- **Scenario 2.2**: List files in an empty folder.
    - **Output**: Empty list.
- **Scenario 2.3**: Filter files by MIME type (JPG, PNG, PDF).
    - **Input**: `folder_id`, `mime_types=['image/jpeg', 'image/png', 'application/pdf']`.
    - **Output**: Filtered list of files.
- **Scenario 2.4**: Handle invalid folder ID.
    - **Output**: Raise specialized Exception (e.g., `GDriveError`).

##### Phase 3: Downloading Files

- **Scenario 3.1**: Download a specific file by ID to a local path.
    - **Input**: `file_id`, `destination_path`.
    - **Output**: Success confirmation (path exists, content matches).
- **Scenario 3.2**: Handle download failures (network issues, permissions).

##### Phase 4: Tracking Processed Files

- **Scenario 4.1**: Check if a file has been processed based on a provided "processed list".
- **Scenario 4.2**: Update the "processed list" after successful download/processing.

#### 4. Suggested Structure

**File: `src/slipstream/integrations/gdrive.py`**

```python
class GDriveClient:
    def __init__(self): ...

    def list_files(self, folder_id, mime_types=None): ...

    def download_file(self, file_id, dest_path): ...
```

**File: `tests/test_gdrive.py`**

- `test_init_client_success`
- `test_list_files_in_folder`
- `test_list_files_filtering`
- `test_download_file_success`
- `test_download_file_not_found`

#### 5. Implementation Milestones (TDD Order)

1. **Red**: Write a test for `GDriveClient` initialization and `list_files` (mocked).
2. **Green**: Implement `GDriveClient` using `google-api-python-client` to pass the test.
3. **Refactor**: Clean up the client code and mock setup.
4. **Red**: Write tests for file filtering and error handling.
5. **Green**: Update `list_files` logic.
6. **Red**: Write tests for `download_file`.
7. **Green**: Implement `download_file` using `MediaIoBaseDownload`.
8. **Red**: Write tests for processed file tracking logic.
9. **Green**: Implement tracking logic.

#### 6. Checklist

- [x] Setup `pytest` fixtures for Google Drive API mocks.
- [x] Implement `GDriveClient.__init__` using Google Cloud Application Default Credentials (ADC).
- [x] Implement `GDriveClient.list_files` with folder ID and MIME type filtering.
- [x] Implement `GDriveClient.download_file` to local temporary storage.
- [x] Add error handling for common API errors (404, 403, network).
- [x] Ensure 100% test coverage for the new module.
